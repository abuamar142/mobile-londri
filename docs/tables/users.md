# üë§ Users & RBAC Implementation

<div align="center">
  <img src="https://img.shields.io/badge/RBAC-FF5722?style=for-the-badge&logoColor=white" alt="RBAC"/>
  <img src="https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white" alt="PostgreSQL"/>
</div>

## üìã Contents

- [Overview](#overview)
- [Database Schema](#database-schema)
- [Custom Types](#custom-types)
- [Tables](#tables)
  - [User Roles](#user-roles)
  - [Role Permissions](#role-permissions)
  - [Users](#users)
- [Authentication Hooks](#authentication-hooks)
- [Triggers & Functions](#triggers--functions)
- [Deep Link Implementation](#deep-link-implementation)
- [Implement RLS](#implement-rls)
- [Related Documentation](#related-documentation)

## üîç Overview

This document details the implementation of **Role-Based Access Control (RBAC)** for the LONDRI
application, including user management, role assignment, and permission handling in Supabase.

## üìä Database Schema

The RBAC system consists of several interconnected tables and functions that control access to
various features of the application based on user roles.

## üè∑Ô∏è Custom Types

```sql
-- Custom permission enum type
CREATE TYPE public.app_permission AS ENUM (
  'users.select',
  'users.insert',
  'users.update',
  'users.delete',
  'user_roles.select',
  'user_roles.insert',
  'user_roles.update',
  'user_roles.delete',
  'customers.select',
  'customers.insert',
  'customers.update',
  'customers.delete',
  'services.select',
  'services.insert',
  'services.update',
  'services.delete',
  'transactions.select',
  'transactions.insert',
  'transactions.update',
  'transactions.delete'
);

-- Custom role enum type
CREATE TYPE public.app_role AS ENUM (
  'super_admin',
  'admin',
  'user'
);
```

## üìë Tables

### User Roles

Manages the relationship between users and their assigned roles.

```sql
CREATE TABLE public.user_roles (
  id        bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id   uuid REFERENCES auth.users ON DELETE CASCADE NOT NULL,
  role      app_role NOT NULL,
  UNIQUE (user_id, role)
);
COMMENT ON TABLE public.user_roles IS 'Application roles for each user.';
```

### Role Permissions

Maps roles to their respective permissions.

```sql
CREATE TABLE public.role_permissions (
  id           bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  role         app_role NOT NULL,
  permission   app_permission NOT NULL,
  UNIQUE (role, permission)
);
COMMENT ON TABLE public.role_permissions IS 'Application permissions for each role.';
```

### Users

Stores user information and links to authentication and roles.

```sql
CREATE TABLE public.users (
    id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
    name varchar(100) NOT NULL,
    email text NOT NULL,
    phone text,
    image_url text,
    role_id bigint REFERENCES public.user_roles(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT (now() AT TIME ZONE 'Asia/Jakarta'),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT (now() AT TIME ZONE 'Asia/Jakarta'),
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);

-- Enable Row Level Security
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- Create an index on user_id for performance
CREATE INDEX idx_users_user_id ON public.users(user_id);
```

## üîê Authentication Hooks

This function adds role information to the JWT token:

```sql
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event jsonb)
RETURNS jsonb
LANGUAGE plpgsql
STABLE
AS $$
  DECLARE
    claims jsonb;
    user_role public.app_role;
  BEGIN
    -- Fetch the user role in the user_roles table
    SELECT role INTO user_role FROM public.user_roles WHERE user_id = (event->>'user_id')::uuid;

    claims := event->'claims';

    IF user_role IS NOT NULL THEN
      -- Set the claim
      claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
    ELSE
      claims := jsonb_set(claims, '{user_role}', 'null');
    END IF;

    -- Update the 'claims' object in the original event
    event := jsonb_set(event, '{claims}', claims);

    -- Return the modified or original event
    RETURN event;
  END;
$$;

-- Set permissions
GRANT USAGE ON SCHEMA public TO supabase_auth_admin;

GRANT EXECUTE
  ON FUNCTION public.custom_access_token_hook
  TO supabase_auth_admin;

REVOKE EXECUTE
  ON FUNCTION public.custom_access_token_hook
  FROM authenticated, anon, public;

GRANT ALL
  ON TABLE public.user_roles
TO supabase_auth_admin;

REVOKE ALL
  ON TABLE public.user_roles
  FROM authenticated, anon, public;

CREATE POLICY "Allow auth admin to read user roles" ON public.user_roles
AS PERMISSIVE FOR SELECT
TO supabase_auth_admin
USING (true)
```

### Authorization Function

```sql
CREATE OR REPLACE FUNCTION public.authorize(
  requested_permission app_permission
)
RETURNS boolean AS $$
DECLARE
  bind_permissions int;
  user_role public.app_role;
BEGIN
  -- Fetch user role once and store it to reduce number of calls
  SELECT (auth.jwt() ->> 'user_role')::public.app_role INTO user_role;

  SELECT count(*)
  INTO bind_permissions
  FROM public.role_permissions
  WHERE role_permissions.permission = requested_permission
    AND role_permissions.role = user_role;

  RETURN bind_permissions > 0;
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER SET search_path = '';
```

## ‚öôÔ∏è Triggers & Functions

### New User Handler

Automatically creates a user record and assigns the 'user' role when a new user registers:

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = ''
AS $$
BEGIN
  INSERT INTO public.users (
    user_id,
    name,
    email
  )
  VALUES (
    new.id,
    new.raw_user_meta_data ->> 'name',
    new.email
  );

  INSERT INTO public.user_roles (
    user_id,
    role
  )
  VALUES (
    new.id,
    'user'
  );

  RETURN new;
END;
$$;

-- Create trigger after user register
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
```

### Role ID Update

Updates the role_id in the users table when a new role is assigned:

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user_role()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  UPDATE public.users
  SET role_id = NEW.id
  WHERE user_id = NEW.user_id;

  RETURN NEW;
END;
$$;

-- Create trigger after insert new user role
CREATE TRIGGER on_user_role_created
  AFTER INSERT ON public.user_roles
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user_role();
```

## üì± Deep Link Implementation

To enable authentication flows with mobile app deep links:

1. Navigate to the
   [Supabase URL Configuration page](https://supabase.com/dashboard/project/<project_id>/auth/url-configuration)
2. Set the site URL to `com.abuamar.londri://callback/`

This allows authentication redirects back to your mobile application.

## üîí Implement RLS (Row Level Security)

This section explains how **Row Level Security (RLS)** is enforced on RBAC-related tables: `users`,
`user_roles`, and `role_permissions`. RLS ensures that only authorized users can perform specific
operations, depending on their assigned roles and permissions.

### ‚úÖ Enable RLS on Tables

```sql
-- Enable RLS for each table
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.role_permissions ENABLE ROW LEVEL SECURITY;
```

### üõ°Ô∏è Create RLS Policies

#### Users Table Policies

```sql
CREATE POLICY "Allow authorized select access" ON public.users
  FOR SELECT TO authenticated
  USING ((SELECT authorize('users.select')));

CREATE POLICY "Allow authorized insert access" ON public.users
  FOR INSERT TO authenticated
  WITH CHECK ((SELECT authorize('users.insert')));

CREATE POLICY "Allow authorized update access" ON public.users
  FOR UPDATE TO authenticated
  USING ((SELECT authorize('users.update')));

CREATE POLICY "Allow authorized delete access" ON public.users
  FOR DELETE TO authenticated
  USING ((SELECT authorize('users.delete')));
```

#### User Roles Table Policies

```sql
CREATE POLICY "Allow authorized select access" ON public.user_roles
  FOR SELECT TO authenticated
  USING ((SELECT authorize('user_roles.select')));

CREATE POLICY "Allow authorized insert access" ON public.user_roles
  FOR INSERT TO authenticated
  WITH CHECK ((SELECT authorize('user_roles.insert')));

CREATE POLICY "Allow authorized update access" ON public.user_roles
  FOR UPDATE TO authenticated
  USING ((SELECT authorize('user_roles.update')));

CREATE POLICY "Allow authorized delete access" ON public.user_roles
  FOR DELETE TO authenticated
  USING ((SELECT authorize('user_roles.delete')));
```

#### Role Permissions Table Policies

Before applying policies to `role_permissions`, ensure all required permissions are present in the
enum:

```sql
-- Add missing permissions to the app_permission enum
BEGIN;

ALTER TYPE public.app_permission ADD VALUE IF NOT EXISTS 'role_permissions.select';
ALTER TYPE public.app_permission ADD VALUE IF NOT EXISTS 'role_permissions.insert';
ALTER TYPE public.app_permission ADD VALUE IF NOT EXISTS 'role_permissions.update';
ALTER TYPE public.app_permission ADD VALUE IF NOT EXISTS 'role_permissions.delete';

COMMIT;
```

```sql
CREATE POLICY "Allow authorized select access" ON public.role_permissions
  FOR SELECT TO authenticated
  USING ((SELECT authorize('role_permissions.select')));

CREATE POLICY "Allow authorized insert access" ON public.role_permissions
  FOR INSERT TO authenticated
  WITH CHECK ((SELECT authorize('role_permissions.insert')));

CREATE POLICY "Allow authorized update access" ON public.role_permissions
  FOR UPDATE TO authenticated
  USING ((SELECT authorize('role_permissions.update')));

CREATE POLICY "Allow authorized delete access" ON public.role_permissions
  FOR DELETE TO authenticated
  USING ((SELECT authorize('role_permissions.delete')));
```

### üßæ Assign Role Permissions

Insert the required permissions into the `role_permissions` table to define which roles are allowed
to perform actions:

```sql
-- Permissions for users table
INSERT INTO public.role_permissions (role, permission) VALUES
  ('super_admin', 'users.select'),
  ('super_admin', 'users.insert'),
  ('super_admin', 'users.update'),
  ('super_admin', 'users.delete'),
  ('admin',       'users.select'),
  ('admin',       'users.insert'),
  ('admin',       'users.update'),
  ('user',        'users.select'),
  ('user',        'users.update');

-- Permissions for user_roles table
INSERT INTO public.role_permissions (role, permission) VALUES
  ('super_admin', 'user_roles.select'),
  ('super_admin', 'user_roles.insert'),
  ('super_admin', 'user_roles.update'),
  ('super_admin', 'user_roles.delete');

-- Permissions for role_permissions table
INSERT INTO public.role_permissions (role, permission) VALUES
  ('super_admin', 'role_permissions.select'),
  ('super_admin', 'role_permissions.insert'),
  ('super_admin', 'role_permissions.update'),
  ('super_admin', 'role_permissions.delete');
```

## üîÑ Related Documentation

- [Main Supabase Setup](../supabase.md)
- [Transactions Table](./transactions.md)

<div align="center">
  <a href="../supabase.md">‚¨ÖÔ∏è Back to Supabase Setup</a>
</div>
